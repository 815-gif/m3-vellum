<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M3 Vellum - System</title>
    <link rel="stylesheet" href="style.css">
    <link rel="icon" type="image/png" href="icon-192.png">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="manifest" href="manifest.json">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Rajdhani:wght@500;700&display=swap" rel="stylesheet">
</head>

<body class="bg-sakura">
    <div id="spectral-anchor"></div>
    
    <div id="system-flash"></div>
    <div class="cherry-container" id="cherry-bg"></div>

    <div id="splash-screen">
        <div class="splash-content">
            <img src="icon-512.png" alt="System Icon" class="splash-logo">
            <div class="splash-loader">
                <div class="loader-bar"></div>
            </div>
            <p class="splash-text">ESTABLECIENDO CONEXI√ìN NEURONAL...</p>
        </div>
    </div>

    <section id="pane-home" class="pane">
        <div class="home-hero-card">
            <div class="hero-header">
                <h1 class="system-title">ESTADO DEL JUGADOR</h1>
                <div class="streak-badge-modern">
                    <span class="fire-icon">üî•</span>
                    <div class="streak-data">
                        <span id="streak-count-display">0</span>
                        <small>RACHA</small>
                    </div>
                </div>
            </div>
            <div class="quote-box-modern">
                <p id="daily-quote">"El l√≠mite solo existe si decides aceptarlo."</p>
            </div>
        </div>

<div class="shadow-shop-ui">
    <h4><i class="fas fa-ghost"></i> TIENDA DE SOMBRAS</h4>
    <div class="shop-buttons">
        <button onclick="comprarMejoraAura('intensidad')">
            SUBIR INTENSIDAD (Lv. <span id="aura-lv">1</span>) <br>
            <small>Costo: <span id="aura-cost">300</span> G</small>
        </button>
        
        <div class="color-picker">
            <button onclick="cambiarColorAura('#800080')" style="background:#800080;"></button>
<button onclick="cambiarColorAura('#ffd700')" style="background:#ffd700;"></button>
<button onclick="cambiarColorAura('#00ff00')" style="background:#00ff00;"></button>
        </div>
    </div>
</div>

        <div class="stats-grid-modern">
            <div class="stat-item-modern">
                <div class="stat-icon">üìö</div>
                <div class="stat-info">
                    <span class="stat-label">BIBLIOTECA</span>
                    <span class="stat-number" id="total-count-home">0</span>
                </div>
            </div>
            <div class="stat-item-modern rank-highlight">
                <div class="stat-icon">üéñÔ∏è</div>
                <div class="stat-info">
                    <span class="stat-label">CATEGOR√çA</span>
                    <span class="stat-number" id="rank-display">RANGO E</span>
                </div>
            </div>
        </div>

        <div class="mission-card-modern">
            <div class="mission-tag">MISI√ìN ACTIVA</div>
            <h3>ENTRENAMIENTO DIARIO</h3>
            <p>Lee cap√≠tulos para obtener recompensas de XP.</p>
            <button onclick="switchPane('library')" class="btn-system-action">ACCEDER AL √ÅREA</button>
        </div>
    </section>

    <section id="pane-library" class="pane hidden">
        <div class="lib-header">
            <h2 class="system-title">REGISTROS</h2>
            <div class="search-wrapper">
                <input type="text" id="input-search" placeholder="Rastrear por nombre o g√©nero..." onkeyup="filtrarManhwas(this.value)">
            </div>
        </div>
        <div id="manhwa-display" class="view-grid"></div>
    </section>

    <section id="pane-profile" class="pane hidden">
        <div class="profile-card-modern">
            <div class="profile-header-main">
                <div class="avatar-wrapper">
                    <div class="avatar-aura" id="avatar-aura-effect"></div>
                    <img id="user-avatar" src="https://api.dicebear.com/7.x/adventurer/svg?seed=Cazador" alt="Avatar">
                    <div class="level-tag-modern">NV.<span id="user-level">1</span></div>
                </div>
                <div class="player-identity">
                    <h2 id="player-name">CAZADOR</h2>
                    <div id="player-title" class="title-badge-gold">INICIADO</div>
                    <div class="gold-status">
                        <span class="gold-icon">üí∞</span>
                        <span id="player-gold-display">0</span>
                    </div>
                </div>
            </div>

            <div class="content-box">
                <h4 class="box-title">‚ö° ESTADO DE VITALIDAD</h4>
                <div class="xp-bar-container" style="background: rgba(255,255,255,0.1); height: 10px;">
                    <div id="energy-fill" class="xp-bar-fill" style="width: 100%; background: #4caf50;"></div>
                </div>
            </div>

            <div class="content-box">
                <h4 class="box-title">üìú LIBRO DE HABILIDADES</h4>
                <div id="skill-book" class="skill-grid-modern">
                    <div class="skill-slot locked" onclick="adquirirHabilidad('ojo-senor')" id="skill-ojo">
                        <div class="skill-inner">üëÅÔ∏è</div>
                        <small>Ojo del Se√±or</small>
                    </div>
                    <div class="skill-slot locked" onclick="adquirirHabilidad('sed-sangre')" id="skill-sed">
                        <div class="skill-inner">ü©∏</div>
                        <small>Sed de Sangre</small>
                    </div>
                </div>
            </div>

            <div id="quest-container"></div>
            <div id="inventory-container"></div>
            
            <div class="content-box">
                <div id="black-market-container"></div>
            </div>

            <div class="content-box">
                <h4 class="box-title">üìä AN√ÅLISIS DE G√âNEROS</h4>
                <div id="genre-stats-container" class="stats-chart-container"></div>
            </div>

            <div class="xp-container-modern">
                <div class="xp-header">
                    <span>EXPERIENCIA</span>
                    <span id="current-xp">0</span>/100
                </div>
                <div class="xp-bar-container">
                    <div id="xp-fill" class="xp-bar-fill"></div>
                </div>
            </div>

            <div class="profile-content-grid">
                <div class="content-box">
                    <h4 class="box-title">üèÜ SALA DE TROFEOS</h4>
                    <div id="achievements-display-list" class="achievement-grid"></div>
                </div>
                <div class="content-box">
                    <h4 class="box-title">üìú HISTORIAL</h4>
                    <div id="milestones-list" class="scroll-area-cute"></div>
                </div>
            </div>

            <button class="config-btn" onclick="toggleInterfaz()">‚öôÔ∏è</button>

            <div id="panel-interfaz" class="interface-panel">
                <h3>SISTEMA</h3>
                <hr>
                <div class="seccion-config">
                    <h4>Gesti√≥n de Datos</h4>
                    <button onclick="exportarDatosCazador()" style="background: #2196f3; color: white;">Exportar Alma</button>
                    <label class="btn-import-label">
                        Importar Alma
                        <input type="file" id="import-file-system" onchange="importarDatosCazador(event)" hidden>
                    </label>
                </div>
                
                <div class="seccion-config">
                    <h4>Fondos de Interfaz</h4>
                    <button onclick="cambiarFondo('default')">Original</button>
                    <button onclick="cambiarFondo('vacio')">Oscuro</button>
                    <button onclick="cambiarFondo('stars')">Estrellas</button>
                    <button onclick="cambiarFondo('dungeon')">Mazmorra</button>
                </div>
                
                <div class="seccion-config">
                    <h4>ZONA PELIGROSA</h4>
                    <button onclick="resetSistemaCompleto()" style="background: #ff4d4d; color: white; border: none; font-weight: bold;">
                        RESETEAR SISTEMA
                    </button>
                </div>
                <hr>
                <button class="google-btn" id="btn-google">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" alt="G">
                    Vincular Alma
                </button>
            </div>
        </div>
    </section>

    <div id="form-overlay" class="overlay hidden">
        <div class="modal system-modal">
            <button class="close-modal-btn" onclick="document.getElementById('form-overlay').classList.add('hidden')">‚úï</button>
            <div class="form-scroll">
                <h2 class="form-header">SINCRONIZAR REGISTRO</h2>
                
                <label>Imagen de Portada</label>
                <input type="file" id="input-file" class="system-input" accept="image/*">
                
                <input type="text" id="input-title" class="system-input" placeholder="T√çTULO">
                
                <div class="input-row">
                    <input type="text" id="input-author" class="system-input" placeholder="AUTOR">
                    <input type="text" id="input-artist" class="system-input" placeholder="ARTISTA">
                </div>
                
                <div class="input-row">
                    <input type="text" id="input-type" class="system-input" placeholder="TIPO (Manhwa, Manga, Novela...)">
                    <input type="text" id="input-demography" class="system-input" placeholder="DEMOGRAF√çA">
                </div>

                <input type="text" id="input-genres" class="system-input" placeholder="G√âNEROS (Acci√≥n, Fantas√≠a...)">
                
                <div class="input-row">
                    <select id="input-status" class="system-input">
                        <option value="Public√°ndose">Public√°ndose</option>
                        <option value="Finalizado">Finalizado</option>
                        <option value="Pausado">Pausado</option>
                        <option value="Hiatus">Hiatus (En espera)</option>
                    </select>
                    <input type="number" id="input-year" class="system-input" placeholder="A√ëO">
                </div>

                <div class="input-row">
                    <div class="input-group">
                        <small>CAP. ACTUAL</small>
                        <input type="number" id="input-current-cap" class="system-input" placeholder="0">
                    </div>
                    <div class="input-group">
                        <small>TOTAL</small>
                        <input type="number" id="input-total-cap" class="system-input" placeholder="?">
                    </div>
                </div>

                <input type="number" id="input-rating" step="0.1" max="5" class="system-input" placeholder="VALORACI√ìN (0-5)">
                
                <button id="save-btn" class="btn-save-modern">CONFIRMAR DATOS</button>
            </div>
        </div>
    </div>

    <div id="details-overlay" class="overlay hidden">
        <div class="modal" id="detail-content"></div>
    </div>

    <nav class="bottom-nav">
        <button onclick="switchPane('home')" id="nav-home" class="nav-item active">üè†</button>
        <button onclick="switchPane('library')" id="nav-library" class="nav-item">üìö</button>
        <button onclick="switchPane('profile')" id="nav-profile" class="nav-item">üë§</button>
    </nav>

    <button id="open-form-btn" class="float-btn" onclick="document.getElementById('form-overlay').classList.remove('hidden'); window.editingIndex = -1;">+</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
  apiKey: "AIzaSyBsMaxIU-wDJPIEyQyO-jsyZgR7ZKB-_h0",
  authDomain: "manhwacloudv2.firebaseapp.com",
  projectId: "manhwacloudv2",
  storageBucket: "manhwacloudv2.firebasestorage.app",
  messagingSenderId: "388201733980",
  appId: "1:388201733980:web:9949d4f5fb0581a9526b99"
};

        const app = initializeApp(firebaseConfig);
        const auth = getAuth();
        const db = getFirestore(app);

        // FUNCI√ìN MEJORADA: SUBIR TODO A LA NUBE
       window.subirALaNube = async function() {
    const u = auth.currentUser;
    if (!u) return; 

    try {
        const docRef = doc(db, "usuarios", u.uid);
        // USAMOS window.myLibrary PARA LLEVARNOS LOS 34
        await setDoc(docRef, {
            manhwas: window.myLibrary, 
            lastUpdate: new Date(),
            oro: parseInt(localStorage.getItem('system_gold')) || 0,
            logros: JSON.parse(localStorage.getItem('logros_sistema')) || []
        }, { merge: true });

        console.log("SISTEMA: Nube actualizada con " + window.myLibrary.length + " manhwas.");
    } catch (error) {
        console.error("Error al sincronizar:", error);
    }
};

        window.vincularAlma = function() {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(console.error);
        };

        onAuthStateChanged(auth, async (u) => {
            if (u) {
                // DESCARGAR DATOS AL ENTRAR
                try {
                    const docRef = doc(db, "usuarios", u.uid);
                    const docSnap = await getDoc(docRef);

                    if (docSnap.exists()) {
                        const datosNube = docSnap.data().manhwas || [];
                        if (datosNube.length > 0) {
                            window.myLibrary = datosNube;
                            localStorage.setItem('myMangaCloud', JSON.stringify(window.myLibrary));
                            if (typeof render === "function") render();
                            if (typeof updateStats === "function") updateStats();
                            console.log("SISTEMA: Biblioteca recuperada (Total: " + datosNube.length + ")");
                        }
                    }
                } catch (e) {
                    console.error("Error al descargar:", e);
                }

                const nameEl = document.getElementById('player-name');
                const avatarEl = document.getElementById('user-avatar');
                if(nameEl) nameEl.innerText = u.displayName.toUpperCase();
                if(u.photoURL && avatarEl) avatarEl.src = u.photoURL;
                
                if (document.getElementById('login-screen')) {
                    document.getElementById('login-screen').classList.add('hidden');
                }
            }
        });

        window.toggleInterfaz = function() {
            const panel = document.getElementById('panel-interfaz');
            if(panel) panel.classList.toggle('active');
        };
    </script>
    <script src="script.js" defer></script>
</body>
</html>

